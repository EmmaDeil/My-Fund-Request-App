<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="logo.png" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Request Dashboard - Advanced Analytics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f23;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a3a 0%, #2d2d5f 100%);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid #333366;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #00d4aa, #00a3ff, #ff6b6b);
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4aa, #00a3ff);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header .subtitle {
            color: #8892b0;
            font-size: 18px;
            font-weight: 400;
        }

        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            background: #1a1a3a;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #333366;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            color: #8892b0;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-input, .control-select {
            background: #0f0f23;
            border: 2px solid #333366;
            border-radius: 12px;
            padding: 12px 16px;
            color: #ffffff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .control-input:focus, .control-select:focus {
            outline: none;
            border-color: #00a3ff;
            box-shadow: 0 0 0 3px rgba(0, 163, 255, 0.1);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #00d4aa, #00a3ff);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 163, 255, 0.3);
        }

        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a3a 0%, #2d2d5f 100%);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #333366;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
        }

        .stat-card.pending::before { --accent-color: #ffd700; }
        .stat-card.approved::before { --accent-color: #00d4aa; }
        .stat-card.rejected::before { --accent-color: #ff6b6b; }
        .stat-card.urgent::before { --accent-color: #ff9500; }
        .stat-card.total::before { --accent-color: #00a3ff; }

        .stat-icon {
            font-size: 28px;
            margin-bottom: 16px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent-color);
        }

        .stat-label {
            color: #8892b0;
            font-size: 16px;
            font-weight: 500;
        }

        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Currency Breakdown */
        .currency-section {
            background: #1a1a3a;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #333366;
        }

        .currency-section h3 {
            color: #ffffff;
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .currency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .currency-card {
            background: #0f0f23;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333366;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .currency-card:hover {
            border-color: #00a3ff;
            transform: scale(1.02);
        }

        .currency-name {
            color: #00a3ff;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 12px;
        }

        .currency-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .currency-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .currency-stat .label {
            color: #8892b0;
        }

        .currency-stat .value {
            color: #ffffff;
            font-weight: 600;
        }

        /* Main Content Grid */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .content-panel {
            background: #1a1a3a;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #333366;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #333366;
        }

        .panel-title {
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Request Items */
        .request-item {
            background: #0f0f23;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #333366;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .request-item:hover {
            border-color: #00a3ff;
            transform: translateX(4px);
        }

        .request-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--status-color);
        }

        .request-item.status-pending::before { --status-color: #ffd700; }
        .request-item.status-approved::before { --status-color: #00d4aa; }
        .request-item.status-rejected::before { --status-color: #ff6b6b; }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .request-title {
            color: #ffffff;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .request-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: #8892b0;
        }

        .amount {
            color: #00d4aa;
            font-weight: 700;
            font-size: 16px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            border: 1px solid #ffd700;
        }

        .status-approved {
            background: rgba(0, 212, 170, 0.2);
            color: #00d4aa;
            border: 1px solid #00d4aa;
        }

        .status-rejected {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }

        .urgent-badge {
            background: linear-gradient(135deg, #ff9500, #ff6b6b);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse 1s ease-in-out infinite alternate;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }

        .pagination button {
            background: #0f0f23;
            border: 1px solid #333366;
            border-radius: 8px;
            padding: 8px 16px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #00a3ff;
            border-color: #00a3ff;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #00a3ff;
            border-color: #00a3ff;
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #8892b0;
            font-style: italic;
        }

        .spinner {
            border: 3px solid #333366;
            border-top: 3px solid #00a3ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        .dashboard-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid #333366;
            color: #8892b0;
            font-size: 14px;
        }

        .last-updated {
            background: #0f0f23;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #333366;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 16px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }
            
            .header {
                padding: 24px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a3a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333366;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00a3ff;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a3a 0%, #2d2d5f 100%);
            border-radius: 16px;
            padding: 0;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #333366;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #00d4aa, #00a3ff);
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
            color: #ffffff;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .detail-item {
            background: #0f0f23;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #333366;
        }

        .detail-label {
            color: #8892b0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .detail-value {
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .detail-description {
            background: #0f0f23;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333366;
            margin-bottom: 24px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .action-btn {
            background: linear-gradient(135deg, #00d4aa, #00a3ff);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 14px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 163, 255, 0.3);
        }

        .action-btn.pdf-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }

        .action-btn.pdf-btn:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .action-btn.retire-btn {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #333;
        }

        .action-btn.retire-btn:hover {
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }

        .action-btn.delete-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .action-btn.delete-btn:hover {
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }

        .status-select {
            background: #0f0f23;
            border: 2px solid #333366;
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .status-select:focus {
            outline: none;
            border-color: #00a3ff;
            box-shadow: 0 0 0 2px rgba(0, 163, 255, 0.2);
        }

        .status-select option {
            background: #1a1a3a;
            color: #ffffff;
            padding: 8px;
        }

        .export-btn {
            background: linear-gradient(135deg, #00d4aa, #00a3ff);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
            width: 100%;
            justify-content: center;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 163, 255, 0.3);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .loading-spinner {
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1>💰 Fund Request Analytics Dashboard</h1>
            <div class="subtitle">Advanced real-time monitoring with currency analytics</div>
            <div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label class="control-label">Search</label>
                <input type="text" class="control-input" id="searchInput" placeholder="Search requests...">
            </div>
            
            <div class="control-group">
                <label class="control-label">Status</label>
                <select class="control-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Currency</label>
                <select class="control-select" id="currencyFilter">
                    <option value="">All Currencies</option>
                    <option value="NGN">Nigerian Naira (₦)</option>
                    <option value="USD">US Dollar ($)</option>
                    <option value="EUR">Euro (€)</option>
                    <option value="GBP">British Pound (£)</option>
                    <option value="CAD">Canadian Dollar (C$)</option>
                </select>
            </div>
            
            
            
            <div class="control-group">
                <label class="control-label">Priority</label>
                <select class="control-select" id="urgentFilter">
                    <option value="">All Priority</option>
                    <option value="true">Urgent Only</option>
                    <option value="false">Normal Only</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Department</label>
                <input type="text" class="control-input" id="departmentFilter" placeholder="Department...">
            </div>
            
            <div class="control-group">
                <label class="control-label">Actions</label>
                <button class="refresh-btn" onclick="refreshData()">🔄 Refresh</button>
               </div>
               <div class="control-group" style="width: 10rem;">
                   <button class="export-btn" onclick="showExportOptions()">
                      <span>📤</span>
                      Export Data
                  </button>
              </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <div class="spinner"></div>
                Loading statistics...
            </div>
        </div>

        <!-- Currency Breakdown -->
        <div class="currency-section">
            <h3>💱 Currency Analytics</h3>
            <div class="currency-grid" id="currencyGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading currency data...
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Requests Panel -->
            <div class="content-panel">
                <div class="panel-header">
                    <div class="panel-title">📋 Fund Requests</div>
                    <div id="filterSummary" style="color: #8892b0; font-size: 14px;"></div>
                </div>
                <div id="requestsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading requests...
                    </div>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>

            <!-- Activity Panel -->
            <div class="content-panel">
                <div class="panel-header">
                    <div class="panel-title">⚡ Recent Activity (Last 8 Hours)</div>
                </div>
                <div id="recentActivity">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading activity...
                    </div>
                </div>

                <div style="margin-top: 32px;">
                    <div class="panel-header">
                        <div class="panel-title">🏢 Departments</div>
                    </div>
                    <div id="departmentsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading departments...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-footer">
            <div class="last-updated">
                <strong>Last Updated:</strong> <span id="lastUpdated">Never</span> | 
                <span id="autoRefresh">Auto-refresh: ON (30s)</span>
            </div>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📋 Fund Request Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Requester</div>
                        <div class="detail-value" id="modal-requester">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Amount</div>
                        <div class="detail-value" id="modal-amount">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            <select id="modal-status-select" class="status-select" onchange="handleStatusChange()">
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Priority</div>
                        <div class="detail-value" id="modal-priority">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Department</div>
                        <div class="detail-value" id="modal-department">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Created Date</div>
                        <div class="detail-value" id="modal-created">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Approver Email</div>
                        <div class="detail-value" id="modal-approver">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Approval Token</div>
                        <div class="detail-value" id="modal-token">-</div>
                    </div>
                </div>
                
                <div class="detail-description">
                    <div class="detail-label">Purpose</div>
                    <div class="detail-value" id="modal-purpose">-</div>
                </div>
                
                <div class="detail-description" id="modal-description-section">
                    <div class="detail-label">Description</div>
                    <div class="detail-value" id="modal-description">-</div>
                </div>

                <div class="action-buttons">
                    <button class="action-btn pdf-btn" id="sendPdfBtn" onclick="sendPDFToApprover()">
                        <span>📄</span>
                        Send PDF
                    </button>
                    <button class="action-btn retire-btn" id="sendRetireBtn" onclick="sendRetireFunds()">
                        <span>💰</span>
                        Retirement
                    </button>
                    <button class="action-btn delete-btn" id="deleteRequestBtn" onclick="deleteRequest()">
                        <span>🗑️</span>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let autoRefreshInterval;
        let currentFilters = {};

        // Exchange rates for estimation (simplified - in production, use a real API)
        const exchangeRates = {
            NGN: { USD: 0.0012, EUR: 0.0011, GBP: 0.00095 },
            USD: { NGN: 830, EUR: 0.92, GBP: 0.79 },
            EUR: { NGN: 900, USD: 1.09, GBP: 0.86 },
            GBP: { NGN: 1050, USD: 1.27, EUR: 1.16 },
            CAD: { NGN: 610, USD: 0.74, EUR: 0.68 }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            setupEventListeners();
            startAutoRefresh();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(loadRequests, 500));
            document.getElementById('statusFilter').addEventListener('change', loadRequests);
            document.getElementById('currencyFilter').addEventListener('change', onCurrencyFilterChange);
            document.getElementById('urgentFilter').addEventListener('change', loadRequests);
            document.getElementById('departmentFilter').addEventListener('input', debounce(loadRequests, 500));
        }

        function onCurrencyFilterChange() {
            updateFilters();
            loadDashboard();
        }

        function updateFilters() {
            currentFilters = {
                search: document.getElementById('searchInput').value,
                status: document.getElementById('statusFilter').value,
                currency: document.getElementById('currencyFilter').value,
                urgent: document.getElementById('urgentFilter').value,
                department: document.getElementById('departmentFilter').value
            };
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function loadDashboard() {
            updateFilters();
            await Promise.all([
                loadStats(),
                loadRequests(),
                loadRecentActivity(),
                loadDepartments()
            ]);
        }

        async function loadStats() {
            try {
                const currency = document.getElementById('currencyFilter').value;
                const params = currency ? `?currency=${currency}` : '';
                
                const response = await fetch(`/api/stats${params}`);
                const stats = await response.json();
                
                displayStats(stats);
                displayCurrencyBreakdown(stats.currencyBreakdown);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function displayStats(stats) {
            const selectedCurrency = stats.selectedCurrency || 'All';
            const currencyLabel = selectedCurrency === 'All' ? 'All Currencies' : selectedCurrency;
            
            const statsHTML = `
                <div class="stat-card pending">
                    <div class="stat-icon">⏳</div>
                    <div class="stat-value">${stats.pending}</div>
                    <div class="stat-label">Pending Requests</div>
                    <div class="stat-change">Awaiting approval</div>
                </div>
                <div class="stat-card approved">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value">${stats.approved}</div>
                    <div class="stat-label">Approved</div>
                    <div class="stat-change">Successfully approved</div>
                </div>
                <div class="stat-card rejected">
                    <div class="stat-icon">❌</div>
                    <div class="stat-value">${stats.rejected}</div>
                    <div class="stat-label">Rejected</div>
                    <div class="stat-change">Declined requests</div>
                </div>
                <div class="stat-card urgent">
                    <div class="stat-icon">🚨</div>
                    <div class="stat-value">${stats.urgent}</div>
                    <div class="stat-label">Urgent</div>
                    <div class="stat-change">High priority</div>
                </div>
                <div class="stat-card total">
                    <div class="stat-icon">💰</div>
                    <div class="stat-value">${formatCurrency(stats.totalAmount, stats.selectedCurrency === 'All' ? '' : stats.selectedCurrency)}</div>
                    <div class="stat-label">Total Amount</div>
                    <div class="stat-change">${currencyLabel}</div>
                </div>
                <div class="stat-card approved">
                    <div class="stat-icon">💵</div>
                    <div class="stat-value">${formatCurrency(stats.approvedAmount, stats.selectedCurrency === 'All' ? '' : stats.selectedCurrency)}</div>
                    <div class="stat-label">Approved Amount</div>
                    <div class="stat-change">${currencyLabel}</div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = statsHTML;
        }

        function displayCurrencyBreakdown(currencyData) {
            if (!currencyData || currencyData.length === 0) {
                document.getElementById('currencyGrid').innerHTML = '<div class="loading">No currency data available</div>';
                return;
            }

            const currencyHTML = currencyData.map(currency => {
                const symbol = getCurrencySymbol(currency._id);
                const estimatedUSD = currency._id !== 'USD' ? estimateInUSD(currency.total, currency._id) : currency.total;
                
                return `
                    <div class="currency-card" onclick="filterByCurrency('${currency._id}')">
                        <div class="currency-name">${symbol} ${currency._id}</div>
                        <div class="currency-stats">
                            <div class="currency-stat">
                                <span class="label">Total Requests:</span>
                                <span class="value">${currency.count}</span>
                            </div>
                            <div class="currency-stat">
                                <span class="label">Total Amount:</span>
                                <span class="value">${formatCurrency(currency.total, currency._id)}</span>
                            </div>
                            <div class="currency-stat">
                                <span class="label">Pending:</span>
                                <span class="value">${formatCurrency(currency.pending || 0, currency._id)}</span>
                            </div>
                            <div class="currency-stat">
                                <span class="label">Approved:</span>
                                <span class="value">${formatCurrency(currency.approved || 0, currency._id)}</span>
                            </div>
                            ${currency._id !== 'USD' ? `
                            <div class="currency-stat" style="border-top: 1px solid #333366; margin-top: 8px; padding-top: 8px;">
                                <span class="label">Est. USD:</span>
                                <span class="value" style="color: #00d4aa;">$${estimatedUSD.toLocaleString()}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('currencyGrid').innerHTML = currencyHTML;
        }

        function estimateInUSD(amount, fromCurrency) {
            if (fromCurrency === 'USD') return amount;
            const rate = exchangeRates[fromCurrency]?.USD || 1;
            return Math.round(amount * rate);
        }

        function filterByCurrency(currency) {
            document.getElementById('currencyFilter').value = currency;
            onCurrencyFilterChange();
        }

        async function loadRequests(page = 1) {
            try {
                updateFilters();
                const params = new URLSearchParams({
                    page: page,
                    limit: 20,
                    ...Object.fromEntries(Object.entries(currentFilters).filter(([_, v]) => v))
                });

                const response = await fetch(`/api/requests?${params}`);
                const data = await response.json();
                
                currentPage = parseInt(data.currentPage);
                totalPages = data.totalPages;
                
                displayRequests(data.requests);
                displayPagination();
                updateFilterSummary(data);
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requestsList').innerHTML = '<div class="loading">Error loading requests</div>';
            }
        }

        function updateFilterSummary(data) {
            const activeFilters = Object.entries(currentFilters)
                .filter(([_, value]) => value)
                .map(([key, value]) => `${key}: ${value}`)
                .join(', ');
            
            const summary = `Showing ${data.requests.length} of ${data.totalRequests} requests${activeFilters ? ` (${activeFilters})` : ''}`;
            document.getElementById('filterSummary').textContent = summary;
        }

        function displayRequests(requests) {
            if (requests.length === 0) {
                document.getElementById('requestsList').innerHTML = '<div class="loading">No requests found</div>';
                return;
            }

            const requestsHTML = requests.map(request => {
                // Normalize denied status to rejected for display
                const displayStatus = request.status === 'denied' ? 'rejected' : request.status;
                const statusText = request.status === 'denied' ? 'denied' : request.status;
                
                return `
                <div class="request-item status-${displayStatus}">
                    <div class="request-header">
                        <div>
                            <div class="request-title">
                                ${request.purpose}
                                ${request.urgent ? '<span class="urgent-badge">URGENT</span>' : ''}
                            </div>
                            <div class="request-meta">
                                <div class="meta-item">
                                    <span>👤</span>
                                    <span>${request.requester_name}</span>
                                </div>
                                <div class="meta-item">
                                    <span>💰</span>
                                    <span class="amount">${formatCurrency(request.amount, request.currency)}</span>
                                </div>
                                <div class="meta-item">
                                    <span>📅</span>
                                    <span>${formatDate(request.created_at)}</span>
                                </div>
                                ${request.department ? `
                                <div class="meta-item">
                                    <span>🏢</span>
                                    <span>${request.department}</span>
                                </div>
                                ` : ''}
                            </div>
                            ${request.description ? `
                            <div style="color: #8892b0; font-size: 14px; margin-top: 8px;">
                                ${request.description}
                            </div>
                            ` : ''}
                        </div>
                        <button class="status-badge status-${displayStatus}" onclick="openRequestModal('${request._id}')" style="cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            ${statusText}
                        </button>
                    </div>
                </div>
            `}).join('');

            document.getElementById('requestsList').innerHTML = requestsHTML;
        }

        function displayPagination() {
            let paginationHTML = '';
            
            paginationHTML += `<button onclick="loadRequests(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>Previous</button>`;
            
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                paginationHTML += `<button onclick="loadRequests(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }
            
            paginationHTML += `<button onclick="loadRequests(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>`;
            
            document.getElementById('pagination').innerHTML = paginationHTML;
        }

        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/recent');
                const recent = await response.json();
                
                const activityHTML = recent.map(request => {
                    // Normalize denied status to rejected for display
                    const displayStatus = request.status === 'denied' ? 'rejected' : request.status;
                    const statusText = request.status === 'denied' ? 'denied' : request.status;
                    
                    return `
                    <div class="request-item status-${displayStatus}" style="margin-bottom: 12px; padding: 16px;">
                        <div class="request-header">
                            <div>
                                <div style="font-weight: 600; font-size: 14px; color: #ffffff; margin-bottom: 4px;">
                                    ${request.requester_name}
                                </div>
                                <div style="color: #8892b0; font-size: 12px; margin-bottom: 8px;">
                                    ${request.purpose.substring(0, 50)}${request.purpose.length > 50 ? '...' : ''}
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <span class="amount" style="font-size: 14px;">${formatCurrency(request.amount, request.currency)}</span>
                                    <span style="color: #8892b0; font-size: 11px;">${formatDate(request.updated_at)}</span>
                                </div>
                            </div>
                            <span class="status-badge status-${displayStatus}" style="font-size: 10px; padding: 4px 8px;">${statusText}</span>
                        </div>
                    </div>
                `}).join('');
                
                document.getElementById('recentActivity').innerHTML = activityHTML || '<div class="loading">No recent activity (last 8 hours)</div>';
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        async function loadDepartments() {
            try {
                const response = await fetch('/api/departments');
                const departments = await response.json();
                
                const departmentsHTML = departments.map(dept => `
                    <div class="request-item" style="padding: 16px; cursor: pointer;" onclick="filterByDepartment('${dept._id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #ffffff; margin-bottom: 8px;">${dept._id}</div>
                                <div style="display: flex; gap: 16px; font-size: 12px;">
                                    <span style="color: #ffd700;">P: ${dept.pending}</span>
                                    <span style="color: #00d4aa;">A: ${dept.approved}</span>
                                    <span style="color: #ff6b6b;">R: ${dept.rejected}</span>
                                </div>
                            </div>
                            <div class="amount">${formatCurrency(dept.totalAmount)}</div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('departmentsList').innerHTML = departmentsHTML || '<div class="loading">No departments found</div>';
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        function filterByDepartment(department) {
            document.getElementById('departmentFilter').value = department;
            loadRequests();
        }

        function getCurrencySymbol(currency) {
            const symbols = { 
                NGN: '₦', 
                USD: '$', 
                EUR: '€', 
                GBP: '£', 
                CAD: 'C$',
                AUD: 'A$',
                JPY: '¥'
            };
            return symbols[currency] || currency;
        }

        function formatCurrency(amount, currency = '') {
            if (!amount) return currency ? `${getCurrencySymbol(currency)} 0` : '0';
            const symbol = currency ? getCurrencySymbol(currency) : '';
            return `${symbol} ${amount.toLocaleString()}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Today';
            if (diffDays === 2) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function refreshData() {
            loadDashboard();
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        }

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                refreshData();
            }, 30000);
        }

        // Initial load
        refreshData();

        // Modal functionality
        let currentRequestData = null;

        async function openRequestModal(requestId) {
            try {
                // Fetch detailed request data
                const response = await fetch(`/api/requests/${requestId}`);
                if (!response.ok) throw new Error('Failed to fetch request details');
                
                const request = await response.json();
                currentRequestData = request;
                
                // Populate modal with request data
                document.getElementById('modal-requester').textContent = request.requester_name;
                document.getElementById('modal-amount').textContent = formatCurrency(request.amount, request.currency);
                document.getElementById('modal-purpose').textContent = request.purpose;
                document.getElementById('modal-department').textContent = request.department || 'Not specified';
                document.getElementById('modal-created').textContent = formatDate(request.created_at);
                document.getElementById('modal-approver').textContent = request.approver_email;
                document.getElementById('modal-token').textContent = request.approval_token || 'Not generated';
                document.getElementById('modal-priority').textContent = request.urgent ? '🚨 URGENT' : '✅ Normal';
                
                // Handle description
                const descriptionSection = document.getElementById('modal-description-section');
                if (request.description) {
                    document.getElementById('modal-description').textContent = request.description;
                    descriptionSection.style.display = 'block';
                } else {
                    descriptionSection.style.display = 'none';
                }
                
                // Set status in select dropdown
                const statusSelect = document.getElementById('modal-status-select');
                statusSelect.value = request.status;
                
                // Enable/disable buttons based on status
                const pdfBtn = document.getElementById('sendPdfBtn');
                const retireBtn = document.getElementById('sendRetireBtn');
                
                if (request.status === 'approved') {
                    pdfBtn.disabled = false;
                    retireBtn.disabled = false;
                } else {
                    pdfBtn.disabled = request.status === 'pending';
                    retireBtn.disabled = true;
                }
                
                // Show modal
                document.getElementById('requestModal').classList.add('show');
                
            } catch (error) {
                console.error('Error loading request details:', error);
                alert('Failed to load request details. Please try again.');
            }
        }

        function closeModal() {
            document.getElementById('requestModal').classList.remove('show');
            currentRequestData = null;
        }

        // Close modal when clicking outside
        document.getElementById('requestModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        async function handleStatusChange() {
            if (!currentRequestData) return;
            
            const statusSelect = document.getElementById('modal-status-select');
            const newStatus = statusSelect.value;
            const oldStatus = currentRequestData.status;
            
            if (newStatus === oldStatus) return;
            
            // Confirmation dialog
            const statusMessages = {
                'pending': 'mark this request as PENDING',
                'approved': 'APPROVE this request',
                'rejected': 'REJECT this request'
            };
            
            const confirmMessage = `Are you sure you want to ${statusMessages[newStatus]}?\n\nRequester: ${currentRequestData.requester_name}\nPurpose: ${currentRequestData.purpose}\nAmount: ${formatCurrency(currentRequestData.amount, currentRequestData.currency)}`;
            
            if (!confirm(confirmMessage)) {
                // Revert select to original value
                statusSelect.value = oldStatus;
                return;
            }
            
            try {
                statusSelect.disabled = true;
                
                const response = await fetch(`/api/requests/${currentRequestData._id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        comments: prompt('Add comments (optional):') || ''
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ Status updated successfully to ${newStatus.toUpperCase()}!`);
                    currentRequestData.status = newStatus;
                    
                    // Update button states
                    const pdfBtn = document.getElementById('sendPdfBtn');
                    const retireBtn = document.getElementById('sendRetireBtn');
                    
                    if (newStatus === 'approved') {
                        pdfBtn.disabled = false;
                        retireBtn.disabled = false;
                    } else {
                        pdfBtn.disabled = newStatus === 'pending';
                        retireBtn.disabled = true;
                    }
                    
                    // Refresh the main dashboard
                    loadDashboard();
                } else {
                    throw new Error(result.message || 'Failed to update status');
                }
                
            } catch (error) {
                console.error('Error updating status:', error);
                alert('❌ Failed to update status: ' + error.message);
                statusSelect.value = oldStatus; // Revert
            } finally {
                statusSelect.disabled = false;
            }
        }

        async function deleteRequest() {
            if (!currentRequestData) return;
            
            // Strong confirmation dialog
            const confirmMessage = `⚠️ DANGER: DELETE REQUEST\n\nThis action cannot be undone!\n\nDetails:\n- Requester: ${currentRequestData.requester_name}\n- Purpose: ${currentRequestData.purpose}\n- Amount: ${formatCurrency(currentRequestData.amount, currentRequestData.currency)}\n- Status: ${currentRequestData.status.toUpperCase()}\n\nType "DELETE" to confirm:`;
            
            const confirmation = prompt(confirmMessage);
            
            if (confirmation !== 'DELETE') {
                alert('❌ Delete cancelled. Request not deleted.');
                return;
            }
            
            const deleteBtn = document.getElementById('deleteRequestBtn');
            const originalText = deleteBtn.innerHTML;
            
            try {
                deleteBtn.innerHTML = '<div class="loading-spinner"></div> Deleting...';
                deleteBtn.disabled = true;
                
                const response = await fetch(`/api/requests/${currentRequestData._id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('✅ Request deleted successfully!');
                    closeModal();
                    loadDashboard(); // Refresh the main dashboard
                } else {
                    throw new Error(result.message || 'Failed to delete request');
                }
                
            } catch (error) {
                console.error('Error deleting request:', error);
                alert('❌ Failed to delete request: ' + error.message);
            } finally {
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        }

        async function sendPDFToApprover() {
            if (!currentRequestData) return;
            
            const btn = document.getElementById('sendPdfBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.innerHTML = '<div class="loading-spinner"></div> Sending PDF...';
                btn.disabled = true;
                
                const response = await fetch('/api/send-pdf-to-approver', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requestId: currentRequestData._id
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('✅ PDF documentation sent successfully to approver!');
                } else {
                    throw new Error(result.error || result.message || 'Failed to send PDF');
                }
                
            } catch (error) {
                console.error('Error sending PDF:', error);
                
                let errorMessage = '❌ Failed to send PDF: ' + error.message;
                
                // Provide specific guidance for email issues
                if (error.message.includes('connect to email server') || 
                    error.message.includes('ECONNREFUSED') ||
                    error.message.includes('Email service unavailable')) {
                    errorMessage += '\\n\\n🔧 Troubleshooting:\\n- Check your internet connection\\n- Verify email server settings\\n- Try again in a few minutes\\n\\n💡 Alternative: You can copy the approver email (' + currentRequestData.approver_email + ') and send them the details manually.';
                } else if (error.message.includes('authentication') || error.message.includes('credentials')) {
                    errorMessage += '\\n\\n🔧 Email credentials may have expired or changed. Please contact the system administrator.';
                } else if (error.message.includes('not configured')) {
                    errorMessage += '\\n\\n🔧 Email service is not properly configured. Please contact the system administrator.';
                }
                
                alert(errorMessage);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = currentRequestData?.status === 'pending';
            }
        }

        async function sendRetireFunds() {
            if (!currentRequestData) return;
            
            const btn = document.getElementById('sendRetireBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.innerHTML = '<div class="loading-spinner"></div> Sending Notice...';
                btn.disabled = true;
                
                const response = await fetch('/api/send-retirement-notice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requestId: currentRequestData._id
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('✅ Retirement notice sent successfully to requester!');
                } else {
                    throw new Error(result.message || 'Failed to send retirement notice');
                }
                
            } catch (error) {
                console.error('Error sending retirement notice:', error);
                alert('❌ Failed to send retirement notice: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = currentRequestData?.status !== 'approved';
            }
        }

        // Export functionality
        function showExportOptions() {
            const format = prompt('Choose export format:\n\nType "PDF" for PDF export\nType "XLS" for Excel export');
            
            if (!format) {
                return; // User cancelled
            }
            
            const formatUpper = format.toUpperCase();
            if (formatUpper === 'PDF') {
                exportData('pdf');
            } else if (formatUpper === 'XLS' || formatUpper === 'EXCEL') {
                exportData('excel');
            } else {
                alert('❌ Invalid format. Please type "PDF" or "XLS"');
            }
        }

        async function exportData(format) {
            try {
                // Get current filter parameters
                const statusFilter = document.getElementById('statusFilter').value;
                const currencyFilter = document.getElementById('currencyFilter').value;
                const searchFilter = document.getElementById('searchInput').value;
                
                // Build query parameters
                const params = new URLSearchParams({
                    format: format,
                    ...(statusFilter && { status: statusFilter }),
                    ...(currencyFilter && { currency: currencyFilter }),
                    ...(searchFilter && { search: searchFilter }),
                    limit: 10000 // Export all matching records
                });
                
                // Show loading state
                const exportBtn = document.querySelector('.export-btn');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<div class="loading-spinner"></div> Exporting...';
                exportBtn.disabled = true;
                
                const response = await fetch(`/api/export?${params}`);
                
                if (!response.ok) {
                    throw new Error(`Export failed: ${response.statusText}`);
                }
                
                // Get the blob data
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const extension = format === 'pdf' ? 'pdf' : 'xlsx';
                a.download = `fund-requests-${timestamp}.${extension}`;
                
                // Trigger download
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert(`✅ Data exported successfully as ${format.toUpperCase()}!`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert('❌ Export failed: ' + error.message);
            } finally {
                // Reset button state
                const exportBtn = document.querySelector('.export-btn');
                exportBtn.innerHTML = '<span>📤</span>Export Data';
                exportBtn.disabled = false;
            }
        }
    </script>
</body>
</html>